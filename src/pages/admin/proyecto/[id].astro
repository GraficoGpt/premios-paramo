---
export const prerender = false
import {
  collection,
  doc,
  getDoc,
  getDocs,
  query,
  where,
} from 'firebase/firestore'
import Head from '../../../components/Head.astro'
import Button from '../../../components/ui/Button.astro'
import LayoutFormularios from '../../../layouts/LayoutFormularios.astro'
import { db } from '../../../lib/firebase'

const { id } = Astro.params

let proyecto = null
let votacion = null

const preguntas = [
  'Calidad t√©cnica del video',
  'Narrativa o guion',
  'Relevancia del mensaje',
  'Creatividad',
  'Impacto visual',
  'Direcci√≥n',
  'Edici√≥n',
  'Dise√±o sonoro',
  'Aporte a la biodiversidad',
  'Coherencia con la categor√≠a',
]

try {
  // 1. Traer proyecto
  const docRef = doc(collection(db, 'proyectos'), id)
  const docSnap = await getDoc(docRef)

  if (docSnap.exists()) {
    proyecto = docSnap.data()
  }

  // 2. Traer votaci√≥n asociada
  const votacionesRef = collection(db, 'votaciones')
  const q = query(votacionesRef, where('idProyecto', '==', id))
  const votacionesSnap = await getDocs(q)

  if (!votacionesSnap.empty) {
    votacion = votacionesSnap.docs[0].data()
  }
} catch (error) {
  console.error('Error al cargar datos:', error)
}
---

<Head
  title="Detalle del proyecto postulado | Premios Pr√≠ncipe de los P√°ramos"
  description="Detalle del proyecto postulado"
/>
<LayoutFormularios>
  <div class="mx-auto max-w-4xl space-y-6 p-6">
    <div class="py-4">
      <Button text="‚Üê Volver al Dashboard" href="/admin" />
    </div>

    {
      proyecto ? (
        <div class="space-y-4 rounded-xl bg-white p-6 shadow">
          <h1 class="text-2xl font-bold text-black">
            {proyecto.nombreObra || 'Sin nombre'}
          </h1>

          <div class="text-sm text-gray-500">
            Postulado por: {proyecto.nombrePostulante || 'No disponible'}
          </div>

          <div class="flex flex-col gap-2 text-sm text-gray-700">
            <div>
              <strong>Categor√≠a:</strong> {proyecto.categorias || 'No asignada'}
            </div>
            <div>
              <strong>Perfil:</strong> {proyecto.perfil || 'No disponible'}
            </div>
            <div>
              <strong>Fecha de Registro:</strong>{' '}
              {proyecto.fechaRegistro || 'No disponible'}
            </div>
            <div>
              <strong>Sinopsis:</strong> {proyecto.sinopsis || 'No disponible'}
            </div>
          </div>

          {/* Links */}
          <div class="mt-6 flex flex-col gap-4">
            {proyecto.linkImagen && (
              <a
                href={proyecto.linkImagen}
                target="_blank"
                class="bg-golddark-500 hover:bg-golddark-600 rounded px-4 py-2 text-center text-white"
              >
                üì∑ Ver Imagen
              </a>
            )}

            {proyecto.linkVideo && (
              <a
                href={proyecto.linkVideo}
                target="_blank"
                class="bg-golddark-500 hover:bg-golddark-600 rounded px-4 py-2 text-center text-white"
              >
                üé¨ Ver Video
              </a>
            )}

            {proyecto.linkLibreto && (
              <a
                href={proyecto.linkLibreto}
                target="_blank"
                class="bg-golddark-500 hover:bg-golddark-600 rounded px-4 py-2 text-center text-white"
              >
                üìÑ Ver Libreto
              </a>
            )}
          </div>

          {/* üî• Resumen de votaci√≥n */}
          {votacion ? (
            <div class="mt-8 space-y-4 rounded-xl bg-gray-100 p-6">
              <h2 class="text-xl font-bold text-black">Resumen de Votaci√≥n</h2>

              <div class="text-sm text-gray-700">
                <strong>Jurado:</strong>{' '}
                {votacion.nombreJurado || 'Nombre no disponible'}
              </div>
              <div class="text-sm text-gray-700">
                <strong>Promedio otorgado:</strong>{' '}
                {votacion.promedio || 'No disponible'}
              </div>
              <div class="text-sm text-gray-700">
                <strong>Fecha de votaci√≥n:</strong>{' '}
                {votacion.fechaVotacion || 'Fecha no disponible'}
              </div>

              {/* üî• Listado de criterios */}
              <div class="mt-4 space-y-2">
                <h3 class="mb-2 font-semibold text-black">
                  Detalle de calificaci√≥n:
                </h3>
                {preguntas.map((pregunta, index) => (
                  <div class="flex justify-between text-sm text-gray-700">
                    <span>{pregunta}</span>
                    <span class="font-semibold">
                      {votacion.respuestas?.[`criterio${index + 1}`] ?? '-'}
                    </span>
                  </div>
                ))}
              </div>
            </div>
          ) : (
            <div class="mt-6 text-sm text-gray-500 italic">
              Proyecto a√∫n no ha sido calificado.
            </div>
          )}
        </div>
      ) : (
        <div class="text-center text-gray-600">Proyecto no encontrado.</div>
      )
    }
  </div>
</LayoutFormularios>
